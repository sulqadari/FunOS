									Task #2
		имплементация минимально работоспособной версии Card Manager.

									Описание
"Card Manager" - ключевой элемент в управлении картой, представлен тремя сущностями:
- GlobalPlatform Environment (OPEN) (п. 3.5):
	- общий интерфейс для приложений;
	- диспетчеризация APDU;
	- выбор приложения;
	- управление данными карты, в т.ч. загрузка, установка и удаление приложений;
	- контроль за соблюдением политики безопасности карты;
	- Ведение Реестра содержимого карты (GlobalPlatform Registry).

- ISD (пп №№ 3.1):
	- обязательный элемент карты, представляет Эмитента.
	- поддержка различных служб безопасности, в т.ч. управление ключами, [де]шифрование,
	  ЦП и верификация.

- CardHolder Verification Method Services (п. 8.2):
	- Глобальная служба идентификации владельца по ПИНу.

Заметка:
Версия должна поддерживать первые шаги процедуры аутентификации, которая осуществляется
на картах NXP посредством инструмента JCShell, а именно:
1. подключение
2. заполучение ATR
3. селектировать CardManager
4. Аутентификация на ключах по протоколу SCP 02 (appendix E):
	INITIALIZE UPDATE (appendix E.5.1)
	=> 80 50 00 00 08 67 5B 9B EF 29 33 92 71 00
	<= 00 00 0D B9 90 A3 51 8E 15 4C	// Key diversification data
	FF 02								// Key version and SCP ID
	00 01								// incremental sequence counter
	6C 7F FC 11 3F B9					// card challenge
	D4 B1 6C EB 10 9D AB EC				// card cryptogram
	90 00
	Status: No Error

	EXTERNAL AUTHENTICATE (appendix E.5.2.2)
	=> 84 82 00 00 10 92 96 EB 5F 60 B9 39 6B 11 BD 78 14 73 F9 EA C5
	<= 90 00
	Status: No Error


									Subgoal #2.1
						GlobalPlatform Environment (OPEN) (глава 6.1)
OPEN - главная административная сущность, которая владеет "GpRegistry". Комментарий
И.Костромина: OPEN - есть операционная система.

'GlobalPlatform Environment' предоставляет следующий функционал:
	- Command Dispatch
		- выбор приложений и ISD;
		- перенаправление APDU;
	- Card Content Management
		- верификация контента;
		- загрузка контента;
		- установка контента;
		- удаление контента;
		- правила доступа к контенту;
	- Security Management
		- [раз]блокировка SD;
		- [раз]блокировка приложения;
		- [раз]блокировка карты;
		- логическое уничтожение карты (termination);
		- управление привилегиями;
		- управление привилегиями SD;
		- трассировка и логирование событий.
	- GlobalPlatform Trusted Framework
		- коммуникация между приложениями.

'GlobalPlatform Environment' можно представить как набор системных функций вокруг
'GpRegistry'.

Примеры, использования 'GpRegistry':
'Command Dispatch'
	- определить, присутствует ли приложение или ISD, могут ли они корректно ответить
	  на команду SELECT.
	- перенаправить команду на целевое приложение для ее дальнейшей обработки.
'Card Content Management'
	- сохранить состояние и служебную информацию загруженных ELF-файлов, исполняемых
	  модулей и установленных приложений.
	- сохранить SD, ассоциированного с загружаемым ELF-файлом.
	- сохранить привилегии, а также SD ассоциированный с устанавливаемым приложением.
	- идентификация SD, ассоциированного с приложением, чтобы предоставить последнему
	  доступ к службам первого.
'Security Management'
	- проверка контента карты посредством извлечения информации о статусе установленных
	  приложений.
	- проверка целостности, а также верификация ELF.
	- проверка соблюдения ограничений на доступ к различным ресурсам в процессе загрузки
	  и установки новых данных; при работе какого-нибудь приложения.
	- проверка прав доступа и привилегий приложения или SD к какой-нибудь функциональности.


									Subgoal #2.1.1
								OPEN Services (глава 6.2)
Приложения и ISD могут получить доступ и/или изменять некоторый контент 'GpRegistry'.
В зависимости от привилегий текущего приложения, 'GpRegistry' может предоставить
следующие службы:
	- инфа о жизненном цикле текущего приложения.
	- инфа о жизненном  цикле карты;
	- доступ к службам SD, ассоциированного с текущим приложением.
	- перевод карты в состояние CARD_LOCKED.
	- модификация поля 'histrorical bytes';
	- изменение жизненного цикла текущего приложения.
	- изменение жизненного цикла карты.
	- доступ к информации самой 'GpRegistry'.
	- доступ к глобальным приложениям (напр, CVM).

Для справки: описанные службы имплементированы в пакете GlobalPlatform для JavaCard.

									Subgoal #2.1.2
								Command Dispatch (глава 6.3)
APDU команды должны обрабатываться либо самим OPEN (читать ОС), либо текущим приложением.

Команда SELECT[by AID] обрабатывается OPEN. Выбрать ISD можно несколькими способами:
	- SELECT[first of only occurence];
	- SELECT[no data];


								
									Subgoal #2.1.3
					Logical Channels and Application selection (глава 6.4.1)
Правила присвоения и неявного выбора приложений:
	- ISD является приложением по умолчанию на всех логических каналах.
	- Приложение можно назначить выбираемым по умолчанию и зарегистрировать таковым в
	  "GpRegistry" если ранее приложение с подобным правом не было зарегистрированно.
	- Приложение с привилегией "Card Reset" но без параметра неявного выбора будет
	  зарегистрированно в "GpRegistry" как неявно селектируемое приложение если ранее
	  не было зарегистрированно приложение с привилегией неявного селектирования.
	- Если неявно селектируемое приложение удалено с карты, тогда ISD становится на его
	  место.
Выбор приложения должен осуществляться либо по reset, либо явным образом по команде
SELECT.

Если жизненный цикл карты находится в стадии CARD_LOCKED или TERMINATED, тогда текущим
приложением может быть только то, что с привилегией "Final application", при этом OPEN
не должен его идентифицировать. При любых других обстоятельствах OPEN должен найти в
"GpRegistry" запись о неявно селектируемом приложении. Если таковое находится в состоянии
LOCKED - опять же, селектируется "Final application".

Заметка: когда настанет время, подробное описание логики команды SELECT можно найти в
параграфе "6.4.2.1.2 Explicit Selection on Basic Logical Channel".

Даже когда приложение выбрано, OPEN все еще отвечает за передачу APDU.

									Subgoal #2.1.4
							GlobalPlatform Registry (глава 6.5)
"GlobalPlatform Registry" - контейнер хранения информации, необходимой для управления
содержимым карты (Card Content Management).
GpRegistry выполняет следующие функции:
	- хранение данных и информации, относящейся к управлению картой;
	- хранение данных и информации, относящейся к управлению приложений (AID, 
	  ассоциированный SD и привелегии);
	- поддержка и актуализация данных управления ресурсами карты;
	- хранение информации о жизненном цикле приложения;
	- хранение информации о жизненном цикле карты;

Содержимое GpRegistry можно обновить с помощью:
	- внутренней логики OPEN;
	- авторизированный запрос приложений.

В GpRegistry должна храниться инфа обо всех приложениях, доменах безопасности и ELF.
Данные управления ресурсами карты должны хранить актуальную инфу о доступной памяти.
Подробности в п. 9.7, "Memory Resource Management". Когда приложение запрашивает
дополнительные ресурсы, OPEN должна свериться с этими данными.

									Subgoal #2.1.5
								Privileges (глава 6.6)

									Subgoal #2.1.6
					The GlobalPlatform Trusted Framework (глава 6.7)

									Subgoal #2.2
							Security Domain (глава 7)
Домен безопасности - это привилегированное приложение. Оно хранит ключи для ЗОС и/или
авторизации доступа к функциям управления картой (Card Content Management).
Все приложения и каждый ELF должны быть ассоциированны с SD. Первые могут использовать
криптографический функционал SD для своих нужд:
	- персонализация: поддержка ЗОС на этапе персонализации приложения.
	- поддержка ЗОС для обмена сообщениями.
Все карты должны иметь один обязательный SD - Issuer Security Domain (ISD). Он обладает
особенностями, которые отличают его от прочих SD:
	- это самое первое приложение на карте.
	- его жизненный цикл наследует состояние карты.
	- принимает привилегию "Card Reset" если приложение с этой привилегией было удалено.
	- принимает привилегию "Final Application" при условиях, описанных выше.
	- становится неявно селектируемым приложением, если приложение с подобной привилегией
	  было удалено.
	- он селектируется если команда SELECT подана с пустым полем "CDATA".
Приложениям нет необходимости заранее знать AID своего SD, т.к. он хранится в "GpRegistry",
а OPEN передаст приложению ссылку на его SD. Хранить эту ссылку приложению не надо, т.к.
в течение жизненного цикла оно может быть экстрадированно другому SD.

									Subgoal #2.2.1
							Security Domain Data (глава 7.4)
Данные, которые должен возвращать ISD на команду 'GET DATA':
	Issuer Identification Number (IIN)
		используется для ассоциации карты с конкретной системой управления картой (Card
		Management System). Хранит идентификатор в формате, определенном в ISO 7812 и
		препровождается тегом '42' (ISO 7816-6). Имеет переменную длину.
	Card Image Number (CIN)
		используется Card Management System для идентификации карты в базе данных. Имеет
		переменную длину и препровождается тегом '45' (ISO 7816-6). Значение задается
		Эмитентом.
	Card Recognition Data
		Card Management System нуждается в информации о карте перед тем как входить с ней
		во взаимодействие, напрмер, данные о типе карты и поддерживаемые протоколы ЗОС.
		Этот тип данных имеет тег '73' и хранится в DO 'Card Data', у которого тег
		'66' (ISO-7816-6).
	Card Capability Info (опционально)
		При наличии дополняет данные из 'Card Recognition Data' подробности в
		appendix 'H.4'.
	Прочие данные Эмитента (при наличии)

									Subgoal #2.2.2
							Security Domain Keys (глава 7.5)
В appendix D, E и F, а также в различных Amendments есть подробная информация о ключах
под каждый тип ЗОС.
Раздел 'C.1' описывает токен, рецепт и ключи DAP.
Ключи имеют следующие атрибуты:
	Key Version Number (KVN) - определяется владельцем ключей.
	Key Identifier (Kid) - определяется владельцем ключей.
	Key Type - ассоциирует ключ с одним и только одним криптографическим алгоритмом.
	Key Length - для криптоалгоритмов, поддерживающих ключи переменной длины.
	Access Conditions - для контроля доступа к ним.
Ключ может состоять из нескольких компонетов, в таком случае все они имеют общий KVN и Kid.
Чтобы заполучить инфу о ключах ISD, необходимо подать команду GET DATA с тегом 'E0'.
ISD должен сохдать всю инфу о ключах, которая подается в команде PUT KEY.
